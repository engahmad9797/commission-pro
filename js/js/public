<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة الإدارة</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:900px; margin:20px auto; padding:10px; }
    input, textarea { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; }
    button { padding:8px 12px; margin-right:8px; }
    .row { display:flex; gap:8px; }
    .card { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:6px; }
  </style>
</head>
<body>
  <h1>لوحة تحكم الموقع</h1>

  <div id="loginBox">
    <h3>تسجيل الدخول</h3>
    <input id="username" placeholder="اسم المستخدم" />
    <input id="password" placeholder="كلمة المرور" type="password" />
    <button onclick="login()">دخول</button>
    <div id="loginMsg"></div>
  </div>

  <div id="adminArea" style="display:none;">
    <button onclick="logout()">تسجيل خروج</button>
    <h3>الصفحات</h3>
    <div id="pagesList"></div>

    <h3>إضافة / تحرير صفحة</h3>
    <input id="pageId" type="hidden" />
    <input id="slug" placeholder="slug (مثال: about)" />
    <input id="title" placeholder="العنوان" />
    <textarea id="body" rows="6" placeholder="المحتوى (HTML مسموح)"></textarea>
    <div class="row">
      <button onclick="savePage()">حفظ</button>
      <button onclick="clearForm()">جديد</button>
    </div>
  </div>

<script>
async function login(){
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const r = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password})});
  const j = await r.json();
  if (r.ok) { document.getElementById('loginBox').style.display='none'; document.getElementById('adminArea').style.display='block'; loadPages(); }
  else document.getElementById('loginMsg').innerText = j.error || 'خطأ';
}

async function loadPages(){
  const r = await fetch('/api/pages'); if (!r.ok) { alert('يرجى تسجيل الدخول'); return; }
  const pages = await r.json();
  const container = document.getElementById('pagesList');
  container.innerHTML = '';
  pages.forEach(p => {
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<strong>${p.title}</strong> <small>/${p.slug}</small>
      <div style="margin-top:8px;">
        <button onclick="editPage(${p.id})">تعديل</button>
        <button onclick="delPage(${p.id})">حذف</button>
      </div>`;
    container.appendChild(div);
  });
}

async function editPage(id){
  const r = await fetch('/api/pages/'+id); const p = await r.json();
  document.getElementById('pageId').value = p.id;
  document.getElementById('slug').value = p.slug;
  document.getElementById('title').value = p.title;
  document.getElementById('body').value = p.body;
}

function clearForm(){
  document.getElementById('pageId').value=''; document.getElementById('slug').value=''; document.getElementById('title').value=''; document.getElementById('body').value='';
}

async function savePage(){
  const id = document.getElementById('pageId').value;
  const slug = document.getElementById('slug').value;
  const title = document.getElementById('title').value;
  const body = document.getElementById('body').value;
  if (!slug || !title) return alert('املأ الحقول المطلوبة');
  const payload = {slug, title, body};
  let r;
  if (!id) r = await fetch('/api/pages', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  else r = await fetch('/api/pages/'+id, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if (r.ok) { clearForm(); loadPages(); } else { const j = await r.json(); alert(j.error || 'خطأ'); }
}

async function delPage(id){
  if (!confirm('هل أنت متأكد؟')) return;
  const r = await fetch('/api/pages/'+id, {method:'DELETE'});
  if (r.ok) loadPages();
  else { const j = await r.json(); alert(j.error || 'خطأ'); }
}

async function logout(){
  await fetch('/api/logout', {method:'POST'});
  document.getElementById('adminArea').style.display='none';
  document.getElementById('loginBox').style.display='block';
}
</script>
</body>
</html>
